---
title: "分布式事务"
date: 2023-07-19
metaAlignment: center
categories:
- 分布式
tags:
- 分布式
---

事务可以保证业务的一致性，分布式事务就是保证分布式系统中多个服务之间的业务一致性。


<!--more-->
2PC、3PC、TCC、本地消息表、消息事务
### 2PC（二阶段提交）

**2PC** 由一个全局的 **事务协调者** 协调各个子事务的 **参与者**（本地资源）完成两阶段提交。

第一阶段是【准备（投票）阶段】

* **协调者** 首先发一个prepare命令 给所有 **参与者**。
* **参与者** 收到消息后，根据自己实际情况，判断是否可以提交，并将结果返回给 **协调者**。
* 同步等待所有 **参与者** 的响应之后进入第二阶段。

第二阶段是【提交阶段】

* **协调者** 收到所有 **参与者** 的确认消息后，判断是否都可以提交。
* 如果在第一阶段所有 **参与者** 都返回成功，协调者则向所有 **参与者** 发送提交事务命令，然后等待所有事务都提交成功之后，返回事务执行成功。
* 如果在第一阶段有某个 **参与者** 返回失败，那么 **协调者** 就会向所有 **参与者** 发送回滚事务的请求，即分布式事务执行失败。

**2PC** 存在很多缺点：

1、**协调者** 挂掉了怎么办？整个分布式就没办法继续执行，
2、假设某个 **参与者** 的提交消息因为网络中断了，请求没有到达，这个也没有发送异常消息回来，那么事务就执行失败了。

### 3PC（三阶段提交）

针对 **2PC** 的缺点，提出了 **3PC**，它在 **协调者** 和 **参与者** 中都引入了超时机制，并且在准备阶段之前增加了 **询问阶段**，然后再锁资源，最后真正提交。
* **询问阶段** **协调者** 向 **参与者** 发送 **cancCommit** 请求，**参与者** 只需根据实际情况返回 Yes 或 No。
* **预提交阶段** 如果所以 **参与者** 都返回 Yes，**协调者** 发送 **preCommit** 请求，**参与者** 执行事务操作（并未提交事务），并将信息记录到事务日志中。
* **提交阶段** 如果所以 **参与者** 预提交成功，**协调者** 发送请求，**参与者** 执行 **commit**；如果有 **参与者** 预提交失败，**协调者** 发送请求，**参与者** 执行 **rollback**。

引入了超时机制，如果是 等待预提交命令 超时可以什么都不用做，如果是 等待提交命令超时，默认执行事务提交，但可能是事务回滚操作，就会出现数据不一致。

### TCC（Try-Confirm-Cancel）

**TCC** 模式可以解决 **2PC** 中资源锁定和阻塞问题，减少资源锁定问题。
* **Try** 阶段做业务检查（一致性）及资源预留（隔离），此阶段是一个初步阶段，要和第二阶段的 **Confirm** 一起才能组成一个完整事务；
* **Confirm** 阶段是确认提交，**Try** 阶段所有分支事务执行成功则执行提交。通常情况认为 **Confirm** 不会失败，即 **Try** 成功，**Confirm** 一定成功，**若真的失败了，就需要引入重试机制或人工处理**。
* **Cancel** 阶段是业务执行失败需要回滚的状态下执行分支事务的业务取消和预留资源释放。通常情况认为 Cancel 也不会失败，**若失败了，也需要引入重试机制或人工处理**。

**Confirm、Cancel 阶段需要重试就需要保证 Confirm 和 Cancel 的幂等性**。

### 本地消息表

### 最大努力通知

### 可靠消息通知

### Seta

